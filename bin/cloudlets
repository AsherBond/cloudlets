#!/usr/bin/env python

import sys
import argparse
import cloudlets
import simplejson as json

parser = argparse.ArgumentParser(description="Manipulate server images in the cloudlets format.")
subcommands = parser.add_subparsers(dest="command")

def main():
    args = parser.parse_args()
    cmd = globals()["cmd_" + args.command]
    cmd(args)

parser_tar = subcommands.add_parser("tar", help="Wrap the image in an uncompressed tar archive and write it to stdout")
parser_tar.add_argument("image", metavar="IMAGE_PATH", help="path to a cloudlet image")
parser_tar.add_argument("--config", metavar="JSON_CONFIG", help="Configure the output, leaving the source untouched", default=None)
def cmd_tar(args):
    cloudlets.Image(args.image).tar(volatile=False, templates=True, persistent=True, other=True, config=args.config and json.loads(args.config))


parser_config = subcommands.add_parser("config", help="Configure an image in-place. If no configuration is given, show current configuration")
parser_config.add_argument("image", metavar="IMAGE_PATH", help="path to a cloudlet image")
parser_config.add_argument("--config", metavar="JSON_CONFIG", help="Apply JSON_CONFIG to the image", default=None)
def cmd_config(args):
    if args.config is None:
        config = cloudlets.Image(args.image).config
        if config != None:
            print json.dumps(config, indent=1)
    else:
        config = json.loads(args.config)
        print "Configuring image %s with:\n-------\n%s\n-------" % (args.image, json.dumps(config, indent=1))
        cloudlets.Image(args.image).config = config

parser_specs = subcommands.add_parser("specs", help="Output the specs for an image manifest, in jsonschema")
def cmd_specs(args):
    print json.dumps(cloudlets.Manifest.specs, indent=1)

parser_validate = subcommands.add_parser("validate", help="Validate a configuration for an image")
parser_validate.add_argument("image", metavar="IMAGE_PATH", help="path to a cloudlet image")
parser_validate.add_argument("--config", metavar="JSON_CONFIG", help="Apply JSON_CONFIG to the image", default=None)
def cmd_validate(args):
    config = json.loads(args.config)
    print "Validating configuration for image %s with:\n-------\n%s\n-------" % (image, json.dumps(config, indent=1))
    cloudlets.Image(args.image).manifest.validate_config(config)

parser_manifest = subcommands.add_parser("manifest", help="Display an image's manifest")
parser_manifest.add_argument("image", metavar="IMAGE_PATH", help="path to a cloudlet image")
def cmd_manifest(args):
    print json.dumps(cloudlets.Image(args.image).manifest, indent=1)

parser_schema = subcommands.add_parser("schema", help="Display an image's configuration schema")
parser_schema.add_argument("image", metavar="IMAGE_PATH", help="path to a cloudlet image")
def cmd_schema(args):
    print json.dumps(cloudlets.Image(args.image).manifest.config_schema, indent=1)


parser_find = subcommands.add_parser("find", help="List the contents of an image, with optional filtering")
parser_find.add_argument("image", metavar="IMAGE_PATH", help="path to a cloudlet image")
parser_find.add_argument("--only", nargs="+", choices=["templates","volatile","persistent","other"], default=["templates", "persistent", "other"])
def cmd_find(args):
    filters = dict([(key, key in args.only) for key in ["templates", "volatile", "persistent", "other"]])
    for path in cloudlets.Image(args.image).find(**filters):
        print path

if __name__ == "__main__":
    main()
